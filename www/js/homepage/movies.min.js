function formatStringForID(a){return a.replace(/[^a-zA-Z 0-9]+/g,"")}var colours={flot:[3,2,4],raphael:[0.6,0.9]};var drawFlot=function(b,c){var a=[];for(i in c.graphs){a.push({data:c.graphs[i].data,label:c.graphs[i].label,yaxis:c.graphs[i].y,bars:{show:c.graphs[i].bars},lines:{show:c.graphs[i].lines},color:colours.flot[i]})}$.plot($("#"+b),a,{legend:{position:c.legend.position,backgroundOpacity:0.6},grid:{clickable:c.grid.clickable,hoverable:true},xaxis:{tickSize:1,ticks:c.x.data,labelAngle:c.x.angle},yaxes:[{ticks:10},{alignTicksWithAxis:c.y.align,position:c.y.position}]})};var showFlotTooltip=function(a,f,d,e,b){$('<div id="tooltip">'+(b?d.toFixed(3):d)+"</div>").css({top:f-30,left:a,backgroundColor:e,borderColor:e}).appendTo("body").fadeIn(200)};var checkJqxhr=function(b,a){if(typeof b==="object"){b.done(function(){if(a!==undefined){$("#"+a).show()}}).fail(function(){wrongParamsInRouter("AJAX failed")}).always(function(){$("#modal-movies-list .progress").fadeOut("fast")})}};var wrongParamsInRouter=function(a){$("#modal-movies-list .modal-body .alert span").html(a);$("#modal-movies-list .modal-body .alert").show()};(function(k){var e,l,n=k("#modal-movies-list"),b=k("#modal-movies-list .modal-body"),d=Backbone.Router.extend({routes:{"by-year/:year":"moviesYear","by-genre/:genre":"moviesGenre","by-director-count/:directors":"moviesDirectors","by-country/:country/:type":"moviesCountry"},moviesYear:function(q){l=formatStringForID(q);if(b.find("#p-year-"+l).length>0){b.find("#p-year-"+l).show()}else{k("#modal-movies-list .progress").show();e=k.getJSON("/ajax-movies-by-year/"+q,function(r){if(r.error!==undefined){wrongParamsInRouter(r.error);return}var s=k("<ul />").attr("id","p-year-"+l).addClass("ajax-movies-data");k.each(r.movies,function(t,u){s.append(k("<li />").append(k("<a />").attr({href:u.link,target:"_blank"}).html(u.title+(u.title_en!==null?" ("+u.title_en+")":""))))});b.append(s)});checkJqxhr(e)}n.modal("show")},moviesGenre:function(q){l=formatStringForID(q);if(b.find("#p-genre-"+l).length>0){b.find("#p-genre-"+l).show()}else{k("#modal-movies-list .progress").show();e=k.getJSON("/ajax-movies-and-series-by-genre/"+q,function(r){if(r.error!==undefined){wrongParamsInRouter(r.error);return}var s=k("<ul />").attr("id","p-genre-"+l).addClass("ajax-movies-data").append(k("<li />").html("<strong>MOVIES:</strong>"));k.each(r.movies,function(t,u){s.append(k("<li />").append(k("<a />").attr({href:u.link,target:"_blank"}).html(u.title+(u.title_en!==null?" ("+u.title_en+")":"")+" ["+u.year+"]")))});s.append(k("<li />").html("<strong>SERIES:</strong>"));k.each(r.series,function(t,u){s.append(k("<li />").append(k("<a />").attr({href:u.link,target:"_blank"}).html(u.title+(u.title_en!==null?" ("+u.title_en+")":"")+" ["+u.year_from+" - "+u.year_until+"]")))});b.append(s)});checkJqxhr(e)}n.modal("show")},moviesDirectors:function(q){l=formatStringForID(q);if(b.find("#p-directed-"+l).length>0){b.find("#p-directed-"+l).show()}else{k("#modal-movies-list .progress").show();e=k.getJSON("/ajax-movies-by-director-count/"+q,function(r){if(r.error!==undefined){wrongParamsInRouter(r.error);return}var s=k("<ul />").attr("id","p-directed-"+l).addClass("ajax-movies-data");k.each(r.directors,function(t,u){s.append(k("<li />").html("<strong>"+u.director+"</strong>").append(k("<ul />").append(k.map(r["movies_"+t],function(v,w){return k("<li />").append(k("<a />").attr({href:v.link,target:"_blank"}).html(v.title+(v.title_en!==null?" ("+v.title_en+")":"")+" ["+v.year+"]")).html()}).join())))});b.append(s)});checkJqxhr(e)}n.modal("show")},moviesCountry:function(r,q){l=formatStringForID(r);if(b.find("#p-"+q+"-"+l).length>0){b.find("#p-"+q+"-"+l).show()}else{k("#modal-movies-list .progress").show();e=k.getJSON("/ajax-movies-and-series-by-country/"+r,function(s){if(s.error!==undefined){wrongParamsInRouter(s.error);return}var t=k("<ul />").attr("id","p-movies-"+l).addClass("ajax-movies-data");k.each(s.movies,function(u,v){t.append(k("<li />").append(k("<a />").attr({href:v.link,target:"_blank"}).html(v.title+(v.title_en!==null?" ("+v.title_en+")":"")+" ["+v.year+"]")))});b.append(t);t=k("<ul />").attr("id","p-series-"+l).addClass("ajax-movies-data");k.each(s.series,function(u,v){t.append(k("<li />").append(k("<a />").attr({href:v.link,target:"_blank"}).html(v.title+(v.title_en!==null?" ("+v.title_en+")":"")+" ["+v.year_from+" - "+v.year_until+"]")))});b.append(t)});checkJqxhr(e,"p-"+q+"-"+l)}n.modal("show")}});n.on("hidden.bs.modal",function(){k(".ajax-movies-data").hide()});new d();Backbone.history.start({silent:true});if(k.fn.plot!==undefined){g={p_year:{grid:{clickable:true},graphs:[{data:d_y,label:"movies ("+Math.ceil(d_y_m[0][1]*d_y_x.length)+")",bars:true,lines:false,y:1},{data:d_y_m,label:"mean",bars:false,lines:true,y:1},{data:d_y_s,label:"standard deviation",bars:false,lines:true,y:1}],legend:{position:"nw"},x:{data:d_y_x,angle:270},y:{align:null,position:"left"}},p_decade:{grid:{clickable:false},graphs:[{data:d_yd,label:"movies",bars:true,lines:false,y:1},{data:d_yd_m,label:"mean",bars:false,lines:true,y:1},{data:d_yd_s,label:"standard deviation",bars:false,lines:true,y:1}],legend:{position:"nw"},x:{data:d_yd_x,angle:0},y:{align:null,position:"left"}},p_genre:{grid:{clickable:true},graphs:[{data:d_g_m,label:"movies",bars:true,lines:false,y:1},{data:d_g_s,label:"tv shows",bars:true,lines:false,y:1},{data:d_g_c,label:"correlation",bars:false,lines:true,y:2}],legend:{position:"nw"},x:{data:d_g_x,angle:270},y:{align:1,position:"right"}},p_directed:{grid:{clickable:true},graphs:[{data:d_d,label:"#movies by directors",bars:true,lines:false,y:1}],legend:{position:"ne"},x:{data:d_d_x,angle:0},y:{align:null,position:"left"}}};for(i in g){drawFlot(i,g[i])}var h=null;var f=null;k(".placeholder").bind("plothover",function(r,s,q){if(q){k(this).css("cursor","pointer");if((h!==q.dataIndex)||(f!==q.series.label)){h=q.dataIndex;f=q.series.label;k("#tooltip").remove();showFlotTooltip(q.pageX,q.pageY,q.datapoint[1],q.series.color,!((k(this).attr("id")==="p_year")||(k(this).attr("id")==="p_decade")||(q.series.label==="correlation")))}}else{k(this).css("cursor","default");k("#tooltip").remove();h=null}});k(".placeholder").bind("plotclick",function(s,t,r){if(r){if(r.series.bars.show){var q=encodeURI(r.series.xaxis.ticks[r.dataIndex].label);switch(s.currentTarget.id){case"p_year":window.location.hash="#by-year/"+q;break;case"p_genre":window.location.hash="#by-genre/"+q;break;case"p_directed":window.location.hash="#by-director-count/"+q;break;default:alert("Nothing's available here :/");break}}}})}if(Raphael!==undefined){var m=/\{([^\}]+)\}/g,c=/(?:(?:^|\.)(.+?)(?=\[|\.|$|\()|\[('|")(.+?)\2\])(\(\))?/g,j=function(s,r,t){var q=t;r.replace(c,function(w,v,u,y,x){v=v||y;if(q){if(v in q){q=q[v]}typeof q=="function"&&x&&(q=q())}});q=(q==null||q==t?s:q)+"";return q},p=function(r,q){return String(r).replace(m,function(t,s){return j(t,s,q)})};Raphael.fn.popup=function(s,q,E,v,L){v=String(v||"top-middle").split("-");v[1]=v[1]||"middle";var F=5,t=E.getBBox(),C=Math.round(t.width),K=Math.round(t.height),A=Math.round(t.x)-F,z=Math.round(t.y)-F,G=Math.min(K/2,C/2,10),H={top:"M{x},{y}h{w4},{w4},{w4},{w4}a{r},{r},0,0,1,{r},{r}v{h4},{h4},{h4},{h4}a{r},{r},0,0,1,-{r},{r}l-{right},0-{gap},{gap}-{gap}-{gap}-{left},0a{r},{r},0,0,1-{r}-{r}v-{h4}-{h4}-{h4}-{h4}a{r},{r},0,0,1,{r}-{r}z",bottom:"M{x},{y}l{left},0,{gap}-{gap},{gap},{gap},{right},0a{r},{r},0,0,1,{r},{r}v{h4},{h4},{h4},{h4}a{r},{r},0,0,1,-{r},{r}h-{w4}-{w4}-{w4}-{w4}a{r},{r},0,0,1-{r}-{r}v-{h4}-{h4}-{h4}-{h4}a{r},{r},0,0,1,{r}-{r}z",right:"M{x},{y}h{w4},{w4},{w4},{w4}a{r},{r},0,0,1,{r},{r}v{h4},{h4},{h4},{h4}a{r},{r},0,0,1,-{r},{r}h-{w4}-{w4}-{w4}-{w4}a{r},{r},0,0,1-{r}-{r}l0-{bottom}-{gap}-{gap},{gap}-{gap},0-{top}a{r},{r},0,0,1,{r}-{r}z",left:"M{x},{y}h{w4},{w4},{w4},{w4}a{r},{r},0,0,1,{r},{r}l0,{top},{gap},{gap}-{gap},{gap},0,{bottom}a{r},{r},0,0,1,-{r},{r}h-{w4}-{w4}-{w4}-{w4}a{r},{r},0,0,1-{r}-{r}v-{h4}-{h4}-{h4}-{h4}a{r},{r},0,0,1,{r}-{r}z"},u={hx0:s-(A+F+C-G*2),hx1:s-(A+F+C/2-G),hx2:s-(A+F+G),vhy:q-(z+F+K+F+G),"^hy":q-(z-G)},J=[{x:A+F,y:z,w:C,w4:C/4,h4:K/4,right:0,left:C-G*2,bottom:0,top:K-G*2,r:F,h:K,gap:G},{x:A+F,y:z,w:C,w4:C/4,h4:K/4,left:C/2-G,right:C/2-G,top:K/2-G,bottom:K/2-G,r:F,h:K,gap:G},{x:A+F,y:z,w:C,w4:C/4,h4:K/4,left:0,right:C-G*2,top:0,bottom:K-G*2,r:F,h:K,gap:G}][v[1]=="middle"?1:(v[1]=="top"||v[1]=="left")*2];var D=0,B=0,I=this.path(p(H[v[0]],J)).insertBefore(E);switch(v[0]){case"top":D=s-(A+F+J.left+G);B=q-(z+F+K+F+G);break;case"bottom":D=s-(A+F+J.left+G);B=q-(z-G);break;case"left":D=s-(A+F+C+F+G);B=q-(z+F+J.top+G);break;case"right":D=s-(A-G);B=q-(z+F+J.top+G);break}I.translate(D,B);if(L){L=I.attr("path");I.remove();return{path:L,dx:D,dy:B}}E.translate(D,B);return I};Raphael.fn.drawGrid=function(B,A,C,v,u,z,s){s=s||"#000";var D=["M",Math.round(B)+0.5,Math.round(A)+0.5,"L",Math.round(B+C)+0.5,Math.round(A)+0.5,Math.round(B+C)+0.5,Math.round(A+v)+0.5,Math.round(B)+0.5,Math.round(A+v)+0.5,Math.round(B)+0.5,Math.round(A)+0.5],q=v/z,r=C/u;for(var t=1;t<z;t++){D=D.concat(["M",Math.round(B)+0.5,Math.round(A+t*q)+0.5,"H",Math.round(B+C)+0.5])}for(t=1;t<u;t++){D=D.concat(["M",Math.round(B+t*r)+0.5,Math.round(A)+0.5,"V",Math.round(A+v)+0.5])}return this.path(D.join(",")).attr({stroke:s})};var a=function(r,q,B,z,w,v){var t=(B-r)/2,s=(w-B)/2,C=Math.atan((B-r)/Math.abs(z-q)),A=Math.atan((w-B)/Math.abs(z-v));C=q<z?Math.PI-C:C;A=v<z?Math.PI-A:A;var u=Math.PI/2-((C+A)%(Math.PI*2))/2,E=t*Math.sin(u+C),y=t*Math.cos(u+C),D=s*Math.sin(u+A),x=s*Math.cos(u+A);return{x1:B-E,y1:z+y,x2:B+D,y2:z+x}};var o=function(B,C,K,w,G){var L=800,F=400,P=30,t=20,E=Raphael(B,L,F),s=(L-P)/w.d.length,O=[],q=0;E.drawGrid(P+s*0.5+0.5,t+0.5,L-P-s,F-t-C,10,10,"#999999");var N=E.set(),x=E.set(),A=E.set(),v=0,u=0,J=false,M,y=E.set(),I=E.set();k.each(G,function(Q,r){O.push(Math.max.apply(null,r.d));A.push(E.text(60,12+15*Q,r.label+" 0").attr({fill:"#ffffff"}))});q=(F-C-t)/Math.max.apply(null,O);A.hide();var D=E.popup(100,100,A,"right").attr({fill:"#000",stroke:"#666","stroke-width":2,"fill-opacity":0.7}).hide();var H,z;k.each(G,function(T,V){var R="hsl("+[colours.raphael[T],0.5,0.5]+")",ae=E.path().attr({stroke:R,"stroke-width":4,"stroke-linejoin":"round"}),U=E.path().attr({stroke:"none",opacity:0.3,fill:R});N.push(ae);x.push(U);I[T]=E.set();for(var S=0,ab=w.d.length;S<ab;S++){var X=Math.round(F-C-q*V.d[S]),Z=Math.round(P+s*(S+0.5)),ad=E.text(Z,F-C+K,w.d[S]).transform("r"+w.a).toBack();if(!S){H=["M",Z,X,"C",Z,X];z=["M",P+s*0.5,F-C,"L",Z,X,"C",Z,X]}if(S&&S<ab-1){var ac=Math.round(F-C-q*V.d[S-1]),Q=Math.round(P+s*(S-0.5)),aa=Math.round(F-C-q*V.d[S+1]),r=Math.round(P+s*(S+1.5));var Y=a(Q,ac,Z,X,r,aa);H=H.concat([Y.x1,Y.y1,Z,X,Y.x2,Y.y2]);z=z.concat([Y.x1,Y.y1,Z,X,Y.x2,Y.y2])}I[T][S]=E.circle(Z,X,4).attr({fill:"#333",stroke:R,"stroke-width":2});if(T===0){y.push(E.rect(P+s*S,0,s,F-C).attr({stroke:"none",fill:"#fff",opacity:0}))}var W=y[y.length-1];(function(af,al,ag,aj,ah){var ak,ai=0;W.hover(function(){clearTimeout(M);var an="right";if(af+D.getBBox().width>L){an="left"}var am=E.popup(af,al,A,an,1),ao=Raphael.animation({path:am.path,transform:["t",am.dx,am.dy]},200*J);v=A[0].transform()[0][1]+am.dx;u=A[0].transform()[0][2]+am.dy;D.show().stop().animate(ao);k.each(G,function(aq,ap){A[aq].attr({text:ap.label+aj+": "+ap.d[ag]}).show().stop().animateWith(D,ao,{transform:["t",v,u]},200*J);ah[aq][ag].attr("r",6)});J=true},function(){k.each(G,function(an,am){ah[an][ag].attr("r",4)});M=setTimeout(function(){D.hide();k.each(A,function(){this.hide()});J=false},1)})})(Z,X,S,w.d[S],I)}H=H.concat([Z,X,Z,X]);z=z.concat([Z,X,Z,X,"L",Z,F-C,"z"]);ae.attr({path:H});U.attr({path:z})});D.toFront();k.each(A,function(){this.toFront()});y.toFront()};o("p-year",30,15,{d:year_labels,a:270},[{d:year_data,label:"Year "}]);o("p-decade",20,10,{d:decade_labels,a:0},[{d:decade_data,label:"Decade "}]);o("p-genre",80,35,{d:genre_labels,a:270},[{d:genre_movies_data,label:"Movies "},{d:genre_series_data,label:"Series "}]);o("p-directed",20,10,{d:directed_labels,a:0},[{d:directed_data,label:"Number of movies "}])}})(jQuery);